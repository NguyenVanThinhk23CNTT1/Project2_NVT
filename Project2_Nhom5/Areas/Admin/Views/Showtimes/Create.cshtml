@model Project2_Nhom5.Models.Showtime

@{
    ViewData["Title"] = "Thêm Lịch chiếu Mới";
    Layout = "~/Areas/Admin/Views/Shared/_AdminLayout.cshtml";
}

@section Styles {
    <style>
        .create-container {
            background: white;
            border-radius: 15px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            padding: 2rem;
            margin: 2rem 0;
        }
        
        .form-section {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
        }
        
        .form-section h5 {
            color: #333;
            margin-bottom: 1rem;
            font-weight: 600;
        }
        
        .preview-section {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 10px;
            padding: 1rem;
            margin-top: 1rem;
        }
    </style>
}

<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2><i class="fas fa-plus-circle"></i>Thêm Lịch chiếu Mới</h2>
                <a href="@Url.Action("Index", "Showtimes", new { area = "Admin" })" class="admin-btn-secondary">
                    <i class="fas fa-arrow-left"></i>Quay lại
                </a>
            </div>
            
            <div class="create-container">
                <form id="createForm" method="post">
                    @Html.AntiForgeryToken()
                    
                    <!-- Thông tin cơ bản -->
                    <div class="form-section">
                        <h5><i class="fas fa-film"></i>Thông tin phim và rạp</h5>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="MovieId">Phim <span class="text-danger">*</span></label>
                                    <select class="form-control" id="MovieId" name="MovieId" required>
                                        <option value="">Chọn phim...</option>
                                        @foreach (var movie in ViewBag.MovieId)
                                        {
                                            <option value="@movie.Value">@movie.Text</option>
                                        }
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="TheaterId">Rạp chiếu <span class="text-danger">*</span></label>
                                    <select class="form-control" id="TheaterId" name="TheaterId" required>
                                        <option value="">Chọn rạp chiếu...</option>
                                        @foreach (var theater in ViewBag.TheaterId)
                                        {
                                            <option value="@theater.Value">@theater.Text</option>
                                        }
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Thời gian chiếu -->
                    <div class="form-section">
                        <h5><i class="fas fa-calendar-alt"></i>Thời gian chiếu</h5>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="ShowDate">Ngày chiếu <span class="text-danger">*</span></label>
                                    <input type="date" class="form-control" id="ShowDate" name="ShowDate" required>
                                    <div class="form-text">Chọn ngày chiếu (từ hôm nay trở đi)</div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="ShowTime">Giờ chiếu <span class="text-danger">*</span></label>
                                    <input type="time" class="form-control" id="ShowTime" name="ShowTime" required>
                                    <div class="form-text">Chọn giờ chiếu (VD: 19:30, 20:00)</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Preview -->
                    <div class="preview-section" id="previewSection" style="display: none;">
                        <h6><i class="fas fa-eye"></i>Xem trước</h6>
                        <div id="previewContent"></div>
                    </div>
                    
                    <!-- Submit -->
                    <div class="text-center mt-4">
                        <button type="submit" class="admin-btn-primary">
                            <i class="fas fa-plus"></i>Tạo lịch chiếu
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        // Cập nhật preview
        function updatePreview() {
            const movieId = document.getElementById('MovieId').value;
            const theaterId = document.getElementById('TheaterId').value;
            const showDate = document.getElementById('ShowDate').value;
            const showTime = document.getElementById('ShowTime').value;
            
            if (movieId && theaterId && showDate && showTime) {
                const movieSelect = document.getElementById('MovieId');
                const theaterSelect = document.getElementById('TheaterId');
                const selectedMovie = movieSelect.options[movieSelect.selectedIndex].text;
                const selectedTheater = theaterSelect.options[theaterSelect.selectedIndex].text;
                
                const previewContent = document.getElementById('previewContent');
                previewContent.innerHTML = `
                    <p><strong>Phim:</strong> ${selectedMovie}</p>
                    <p><strong>Rạp chiếu:</strong> ${selectedTheater}</p>
                    <p><strong>Ngày chiếu:</strong> ${showDate}</p>
                    <p><strong>Giờ chiếu:</strong> ${showTime}</p>
                `;
                
                document.getElementById('previewSection').style.display = 'block';
            } else {
                document.getElementById('previewSection').style.display = 'none';
            }
        }
        
        // Event listeners
        document.getElementById('MovieId').addEventListener('change', updatePreview);
        document.getElementById('TheaterId').addEventListener('change', updatePreview);
        document.getElementById('ShowDate').addEventListener('change', updatePreview);
        document.getElementById('ShowTime').addEventListener('change', updatePreview);
        
        // Form submit
        document.getElementById('createForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const movieId = document.getElementById('MovieId').value;
            const theaterId = document.getElementById('TheaterId').value;
            const showDate = document.getElementById('ShowDate').value;
            const showTime = document.getElementById('ShowTime').value;
            
            // Validation
            if (!movieId) {
                Swal.fire({
                    icon: 'error',
                    title: 'Lỗi!',
                    text: 'Vui lòng chọn phim',
                    confirmButtonText: 'Đóng',
                    confirmButtonColor: '#dc3545'
                });
                return;
            }
            
            if (!theaterId) {
                Swal.fire({
                    icon: 'error',
                    title: 'Lỗi!',
                    text: 'Vui lòng chọn rạp chiếu',
                    confirmButtonText: 'Đóng',
                    confirmButtonColor: '#dc3545'
                });
                return;
            }
            
            if (!showDate) {
                Swal.fire({
                    icon: 'error',
                    title: 'Lỗi!',
                    text: 'Vui lòng chọn ngày chiếu',
                    confirmButtonText: 'Đóng',
                    confirmButtonColor: '#dc3545'
                });
                return;
            }
            
            if (!showTime) {
                Swal.fire({
                    icon: 'error',
                    title: 'Lỗi!',
                    text: 'Vui lòng chọn giờ chiếu',
                    confirmButtonText: 'Đóng',
                    confirmButtonColor: '#dc3545'
                });
                return;
            }
            
            // Kiểm tra ngày chiếu không được trong quá khứ
            const selectedDate = new Date(showDate);
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            
            if (selectedDate < today) {
                Swal.fire({
                    icon: 'error',
                    title: 'Lỗi!',
                    text: 'Ngày chiếu không được trong quá khứ',
                    confirmButtonText: 'Đóng',
                    confirmButtonColor: '#dc3545'
                });
                return;
            }
            
            // Show loading
            Swal.fire({
                title: 'Đang tạo lịch chiếu...',
                allowOutsideClick: false,
                didOpen: () => {
                    Swal.showLoading();
                }
            });
            
            try {
                const formData = new FormData(this);
                const requestData = {
                    MovieId: parseInt(movieId),
                    TheaterId: parseInt(theaterId),
                    ShowDate: showDate,
                    ShowTime: showTime
                };
                
                const response = await fetch('@Url.Action("Create", "Showtimes", new { area = "Admin" })', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'RequestVerificationToken': document.querySelector('input[name="__RequestVerificationToken"]').value
                    },
                    body: JSON.stringify(requestData)
                });
                
                const result = await response.json();
                
                if (result.success) {
                                            Swal.fire({
                            html: `
                                <div class="mt-3 text-center">
                                    <lord-icon src="https://cdn.lordicon.com/lupuorrc.json" trigger="loop" colors="primary:#0ab39c,secondary:#405189" style="width:120px;height:120px">
                                    </lord-icon>
                                    <div class="mt-4 pt-2 fs-15">
                                        <h4 style="color: #333; font-weight: 600; margin-bottom: 8px;">Thành công!</h4>
                                        <p style="color: #666; margin: 0;">${result.message}</p>
                                    </div>
                                </div>
                            `,
                        showConfirmButton: true,
                        confirmButtonText: 'Ok',
                        confirmButtonColor: '#0ab39c',
                        allowOutsideClick: true,
                        allowEscapeKey: true,
                        customClass: {
                            popup: 'swal2-custom-popup',
                            confirmButton: 'btn btn-primary w-xs mb-1'
                        },
                        background: '#fff',
                        backdrop: 'rgba(0,0,0,0.4)'
                    }).then(() => {
                        window.location.href = '@Url.Action("Index", "Showtimes", new { area = "Admin" })';
                    });
                } else {
                    Swal.fire({
                        icon: 'error',
                        title: 'Lỗi!',
                        text: result.message,
                        confirmButtonText: 'Đóng',
                        confirmButtonColor: '#dc3545'
                    });
                }
            } catch (error) {
                Swal.fire({
                    icon: 'error',
                    title: 'Lỗi!',
                    text: 'Có lỗi xảy ra khi tạo lịch chiếu',
                    confirmButtonText: 'Đóng',
                    confirmButtonColor: '#dc3545'
                });
            }
        });
        
        // Set default date to today
        document.addEventListener('DOMContentLoaded', function() {
            const today = new Date();
            document.getElementById('ShowDate').value = today.toISOString().split('T')[0];
            updatePreview();
        });
    </script>
}