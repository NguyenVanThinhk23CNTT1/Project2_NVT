@{
    ViewData["Title"] = "Thêm Lịch Chiếu Hàng Loạt";
    Layout = "~/Areas/Admin/Views/Shared/_AdminLayout.cshtml";
}

@section Styles {
    <style>
        .bulk-create-container {
            background: white;
            border-radius: 15px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            padding: 2rem;
            margin: 2rem 0;
        }
        
        .form-section {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
        }
        
        .form-section h5 {
            color: #333;
            margin-bottom: 1rem;
            font-weight: 600;
        }
        
        .day-checkbox {
            display: inline-block;
            margin: 0.5rem;
        }
        
        .day-checkbox input[type="checkbox"] {
            display: none;
        }
        
        .day-checkbox label {
            display: inline-block;
            padding: 8px 16px;
            background: #e9ecef;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 500;
        }
        
        .day-checkbox input[type="checkbox"]:checked + label {
            background: linear-gradient(135deg, #ff6b35 0%, #f7931e 100%);
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(255, 107, 53, 0.3);
        }
        
        .time-input-group {
            display: flex;
            align-items: center;
            margin-bottom: 1rem;
        }
        
        .time-input {
            flex: 1;
            margin-right: 1rem;
        }
        
        .remove-time-btn {
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a24 100%);
            border: none;
            color: white;
            padding: 8px 12px;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 3px 10px rgba(255, 107, 107, 0.3);
        }
        
        .remove-time-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(255, 107, 107, 0.4);
        }
        
        .add-time-btn {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            border: none;
            color: white;
            padding: 10px 20px;
            border-radius: 25px;
            cursor: pointer;
            margin-top: 1rem;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(79, 172, 254, 0.3);
            font-weight: 600;
        }
        
        .add-time-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(79, 172, 254, 0.4);
        }
        
        .preview-section {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 10px;
            padding: 1rem;
            margin-top: 1rem;
        }
    </style>
}

<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2><i class="fas fa-layer-group"></i>Thêm Lịch Chiếu Hàng Loạt</h2>
                <a href="@Url.Action("Index", "Showtimes", new { area = "Admin" })" class="admin-btn-secondary">
                    <i class="fas fa-arrow-left"></i>Quay lại
                </a>
            </div>
            
            <div class="bulk-create-container">
                <form id="bulkCreateForm" method="post">
                    @Html.AntiForgeryToken()
                    <!-- Thông tin cơ bản -->
                    <div class="form-section">
                        <h5><i class="fas fa-film"></i>Thông tin phim và rạp</h5>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="MovieId">Phim</label>
                                    <select class="form-control" id="MovieId" name="MovieId" required>
                                        <option value="">Chọn phim...</option>
                                        @foreach (var movie in ViewBag.MovieId)
                                        {
                                            <option value="@movie.Value">@movie.Text</option>
                                        }
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="TheaterId">Rạp chiếu</label>
                                    <select class="form-control" id="TheaterId" name="TheaterId" required>
                                        <option value="">Chọn rạp chiếu...</option>
                                        @foreach (var theater in ViewBag.TheaterId)
                                        {
                                            <option value="@theater.Value">@theater.Text</option>
                                        }
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Khoảng thời gian -->
                    <div class="form-section">
                        <h5><i class="fas fa-calendar"></i>Khoảng thời gian</h5>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="StartDate">Từ ngày</label>
                                    <input type="date" class="form-control" id="StartDate" name="StartDate" required>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="EndDate">Đến ngày</label>
                                    <input type="date" class="form-control" id="EndDate" name="EndDate" required>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Ngày trong tuần -->
                    <div class="form-section">
                        <h5><i class="fas fa-calendar-week"></i>Ngày trong tuần</h5>
                        <div class="day-selection">
                            <div class="day-checkbox">
                                <input type="checkbox" id="day0" name="SelectedDays" value="0">
                                <label for="day0">Chủ nhật</label>
                            </div>
                            <div class="day-checkbox">
                                <input type="checkbox" id="day1" name="SelectedDays" value="1">
                                <label for="day1">Thứ 2</label>
                            </div>
                            <div class="day-checkbox">
                                <input type="checkbox" id="day2" name="SelectedDays" value="2">
                                <label for="day2">Thứ 3</label>
                            </div>
                            <div class="day-checkbox">
                                <input type="checkbox" id="day3" name="SelectedDays" value="3">
                                <label for="day3">Thứ 4</label>
                            </div>
                            <div class="day-checkbox">
                                <input type="checkbox" id="day4" name="SelectedDays" value="4">
                                <label for="day4">Thứ 5</label>
                            </div>
                            <div class="day-checkbox">
                                <input type="checkbox" id="day5" name="SelectedDays" value="5">
                                <label for="day5">Thứ 6</label>
                            </div>
                            <div class="day-checkbox">
                                <input type="checkbox" id="day6" name="SelectedDays" value="6">
                                <label for="day6">Thứ 7</label>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Giờ chiếu -->
                    <div class="form-section">
                        <h5><i class="fas fa-clock"></i>Giờ chiếu</h5>
                        <div id="timeInputs">
                            <div class="time-input-group">
                                <input type="time" class="form-control time-input" name="ShowTimes" required>
                                <button type="button" class="remove-time-btn" onclick="removeTimeInput(this)">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                        <button type="button" class="add-time-btn" onclick="addTimeInput()">
                            <i class="fas fa-plus"></i>Thêm giờ chiếu
                        </button>
                    </div>
                    
                    <!-- Preview -->
                    <div class="preview-section" id="previewSection" style="display: none;">
                        <h6><i class="fas fa-eye"></i>Xem trước</h6>
                        <div id="previewContent"></div>
                    </div>
                    
                    <!-- Submit -->
                    <div class="text-center mt-4">
                        <button type="submit" class="admin-btn-primary">
                            <i class="fas fa-plus"></i>Tạo lịch chiếu hàng loạt
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        // Thêm giờ chiếu
        function addTimeInput() {
            const timeInputs = document.getElementById('timeInputs');
            const newTimeGroup = document.createElement('div');
            newTimeGroup.className = 'time-input-group';
            newTimeGroup.innerHTML = `
                <input type="time" class="form-control time-input" name="ShowTimes" required>
                <button type="button" class="remove-time-btn" onclick="removeTimeInput(this)">
                    <i class="fas fa-trash"></i>
                </button>
            `;
            timeInputs.appendChild(newTimeGroup);
            updatePreview();
        }
        
        // Xóa giờ chiếu
        function removeTimeInput(button) {
            const timeInputs = document.getElementById('timeInputs');
            if (timeInputs.children.length > 1) {
                button.parentElement.remove();
                updatePreview();
            }
        }
        
        // Cập nhật preview
        function updatePreview() {
            const startDate = document.getElementById('StartDate').value;
            const endDate = document.getElementById('EndDate').value;
            const selectedDays = Array.from(document.querySelectorAll('input[name="SelectedDays"]:checked')).map(cb => parseInt(cb.value));
            const showTimes = Array.from(document.querySelectorAll('input[name="ShowTimes"]')).map(input => input.value).filter(time => time);
            
            if (startDate && endDate && selectedDays.length > 0 && showTimes.length > 0) {
                const start = new Date(startDate);
                const end = new Date(endDate);
                const dayNames = ['Chủ nhật', 'Thứ 2', 'Thứ 3', 'Thứ 4', 'Thứ 5', 'Thứ 6', 'Thứ 7'];
                
                let totalShowtimes = 0;
                for (let date = new Date(start); date <= end; date.setDate(date.getDate() + 1)) {
                    if (selectedDays.includes(date.getDay())) {
                        totalShowtimes += showTimes.length;
                    }
                }
                
                const previewContent = document.getElementById('previewContent');
                previewContent.innerHTML = `
                    <p><strong>Tổng số lịch chiếu sẽ được tạo:</strong> ${totalShowtimes}</p>
                    <p><strong>Ngày:</strong> ${startDate} đến ${endDate}</p>
                    <p><strong>Ngày trong tuần:</strong> ${selectedDays.map(day => dayNames[day]).join(', ')}</p>
                    <p><strong>Giờ chiếu:</strong> ${showTimes.join(', ')}</p>
                `;
                
                document.getElementById('previewSection').style.display = 'block';
            } else {
                document.getElementById('previewSection').style.display = 'none';
            }
        }
        
        // Event listeners
        document.getElementById('StartDate').addEventListener('change', updatePreview);
        document.getElementById('EndDate').addEventListener('change', updatePreview);
        document.querySelectorAll('input[name="SelectedDays"]').forEach(cb => cb.addEventListener('change', updatePreview));
        document.addEventListener('input', function(e) {
            if (e.target.name === 'ShowTimes') {
                updatePreview();
            }
        });
        
        // Form submit
        document.getElementById('bulkCreateForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const formData = new FormData(this);
            const requestData = {
                MovieId: parseInt(formData.get('MovieId')),
                TheaterId: parseInt(formData.get('TheaterId')),
                StartDate: formData.get('StartDate'),
                EndDate: formData.get('EndDate'),
                SelectedDays: Array.from(document.querySelectorAll('input[name="SelectedDays"]:checked')).map(cb => parseInt(cb.value)),
                ShowTimes: Array.from(document.querySelectorAll('input[name="ShowTimes"]')).map(input => input.value).filter(time => time)
            };
            
            if (requestData.SelectedDays.length === 0) {
                Swal.fire({
                    icon: 'error',
                    title: 'Lỗi!',
                    text: 'Vui lòng chọn ít nhất một ngày trong tuần',
                    confirmButtonText: 'Đóng',
                    confirmButtonColor: '#dc3545'
                });
                return;
            }
            
            if (requestData.ShowTimes.length === 0) {
                Swal.fire({
                    icon: 'error',
                    title: 'Lỗi!',
                    text: 'Vui lòng nhập ít nhất một giờ chiếu',
                    confirmButtonText: 'Đóng',
                    confirmButtonColor: '#dc3545'
                });
                return;
            }
            
            try {
                const response = await fetch('@Url.Action("BulkCreate", "Showtimes", new { area = "Admin" })', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'RequestVerificationToken': document.querySelector('input[name="__RequestVerificationToken"]').value
                    },
                    body: JSON.stringify(requestData)
                });
                
                const result = await response.json();
                
                if (result.success) {
                    Swal.fire({
                        html: `
                            <div class="mt-3 text-center">
                                <lord-icon src="https://cdn.lordicon.com/lupuorrc.json" trigger="loop" colors="primary:#0ab39c,secondary:#405189" style="width:120px;height:120px">
                                </lord-icon>
                                <div class="mt-4 pt-2 fs-15">
                                    <h4 style="color: #333; font-weight: 600; margin-bottom: 8px;">Thành công!</h4>
                                    <p style="color: #666; margin: 0;">${result.message}</p>
                                    <p style="color: #666; margin: 8px 0 0 0; font-size: 0.9em;">Đã tạo ${result.count} lịch chiếu thành công!</p>
                                </div>
                            </div>
                        `,
                        showConfirmButton: true,
                        confirmButtonText: 'Ok',
                        confirmButtonColor: '#0ab39c',
                        allowOutsideClick: true,
                        allowEscapeKey: true,
                        customClass: {
                            popup: 'swal2-custom-popup',
                            confirmButton: 'btn btn-primary w-xs mb-1'
                        },
                        background: '#fff',
                        backdrop: 'rgba(0,0,0,0.4)'
                    }).then(() => {
                        window.location.href = '@Url.Action("Index", "Showtimes", new { area = "Admin" })';
                    });
                } else {
                    Swal.fire({
                        icon: 'error',
                        title: 'Lỗi!',
                        text: result.message,
                        confirmButtonText: 'Đóng',
                        confirmButtonColor: '#dc3545'
                    });
                }
            } catch (error) {
                Swal.fire({
                    icon: 'error',
                    title: 'Lỗi!',
                    text: 'Có lỗi xảy ra khi tạo lịch chiếu',
                    confirmButtonText: 'Đóng',
                    confirmButtonColor: '#dc3545'
                });
            }
        });
        
        // Set default dates
        document.addEventListener('DOMContentLoaded', function() {
            const today = new Date();
            const nextWeek = new Date(today);
            nextWeek.setDate(today.getDate() + 7);
            
            document.getElementById('StartDate').value = today.toISOString().split('T')[0];
            document.getElementById('EndDate').value = nextWeek.toISOString().split('T')[0];
            
            // Check weekend days by default
            document.getElementById('day5').checked = true; // Friday
            document.getElementById('day6').checked = true; // Saturday
            document.getElementById('day0').checked = true; // Sunday
            
            updatePreview();
        });
    </script>
} 


