@model Project2_Nhom5.Areas.Guest.Models.PaymentViewModel
@{
    ViewData["Title"] = "Thanh Toán";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

@if (Model == null)
{
    <div class="container mt-5">
        <div class="alert alert-danger">
            <h4>Lỗi tải dữ liệu thanh toán</h4>
            <p>Không thể tải thông tin thanh toán. Vui lòng thử lại.</p>
            <a href="@Url.Action("Index", "Home")" class="btn btn-primary">Về trang chủ</a>
        </div>
    </div>
    return;
}

@section Styles {
    <style>
        :root { --primary-color: #ff6b35; --secondary-color: #1a1a2e; --accent-color: #16213e; --text-primary: #333; --text-secondary: #666; --footer-text: #666; --bg-primary: #ffffff; --bg-secondary: #f8f9fa; --card-bg: #ffffff; --border-color: #e0e0e0; --shadow: 0 4px 20px rgba(0,0,0,0.1); --gradient: linear-gradient(135deg, #ff6b35 0%, #f7931e 100%); }
        [data-theme="dark"] { --text-primary: #ffffff; --text-secondary: #b0b0b0; --footer-text: #b0b0b0; --bg-primary: #0f0f1a; --bg-secondary: #1a1a2e; --card-bg: #16213e; --border-color: #333; --shadow: 0 4px 20px rgba(0,0,0,0.3); }
        [data-theme="dark"] .form-control, [data-theme="dark"] .form-select { background-color: var(--bg-secondary); border-color: var(--border-color); color: var(--text-primary); }
        [data-theme="dark"] .form-control:focus, [data-theme="dark"] .form-select:focus { background-color: var(--card-bg); border-color: var(--primary-color); color: var(--text-primary); box-shadow: 0 0 0 0.2rem rgba(255, 107, 53, 0.25); }
        [data-theme="dark"] .form-control::placeholder { color: var(--text-secondary); }
        [data-theme="dark"] .modal-backdrop { background-color: rgba(0, 0, 0, 0.8); }
        * { transition: all 0.3s ease; }
        .hero-section { background: var(--bg-primary); min-height: 30vh; display: flex; align-items: center; position: relative; overflow: hidden; }
        .hero-title { font-size: 2rem; font-weight: bold; margin-bottom: 1rem; background: var(--gradient); -webkit-background-clip: text; background-clip: text; -webkit-text-fill-color: transparent; }
        .hero-subtitle { font-size: 1rem; color: var(--text-secondary); margin-bottom: 1.5rem; }
        .payment-container { background: var(--card-bg); border-radius: 20px; padding: 2rem; box-shadow: var(--shadow); border: 1px solid var(--border-color); }
        .movie-info-card { background: var(--card-bg); border-radius: 15px; overflow: hidden; box-shadow: var(--shadow); border: 1px solid var(--border-color); margin-bottom: 2rem; }
        .movie-poster { width: 100%; height: 200px; object-fit: cover; }
        .movie-details { padding: 1.5rem; }
        .movie-title { font-size: 1.3rem; font-weight: bold; margin-bottom: 0.5rem; color: var(--text-primary); }
        .movie-info { color: var(--text-secondary); font-size: 0.9rem; margin-bottom: 0.5rem; }
        .selected-seats { background: var(--bg-secondary); border-radius: 10px; padding: 1rem; margin-bottom: 1.5rem; }
        .seat-item { display: flex; justify-content: space-between; align-items: center; padding: 0.5rem 0; border-bottom: 1px solid var(--border-color); }
        .seat-item:last-child { border-bottom: none; }
        .seat-code { font-weight: 600; color: var(--text-primary); }
        .seat-price { color: var(--text-secondary); }
        .discount-section { background: var(--bg-secondary); border-radius: 10px; padding: 1.5rem; margin-bottom: 1.5rem; }
        .discount-input-group { display: flex; gap: 0.5rem; }
        .discount-input { flex: 1; border-radius: 25px; border: 2px solid var(--border-color); padding: 10px 15px; }
        .apply-discount-btn { background: var(--gradient); border: none; padding: 10px 20px; border-radius: 25px; color: white; font-weight: 600; }
        .payment-methods { margin-bottom: 1.5rem; }
        .payment-method { display: flex; align-items: center; gap: 0.5rem; padding: 1rem; border: 2px solid var(--border-color); border-radius: 10px; margin-bottom: 0.5rem; cursor: pointer; transition: all 0.3s ease; }
        .payment-method:hover { border-color: var(--primary-color); }
        .payment-method.selected { border-color: var(--primary-color); background: rgba(255, 107, 53, 0.1); }
        .payment-method input[type="radio"] { margin: 0; }
        .payment-summary { background: var(--bg-secondary); border-radius: 10px; padding: 1.5rem; margin-bottom: 1.5rem; }
        .summary-item { display: flex; justify-content: space-between; align-items: center; padding: 0.5rem 0; }
        .summary-label { color: var(--text-secondary); }
        .summary-value { font-weight: 600; color: var(--text-primary); }
        .total-amount { font-size: 1.2rem; font-weight: bold; color: var(--primary-color); border-top: 2px solid var(--border-color); padding-top: 1rem; margin-top: 1rem; }
        .pay-btn { background: var(--gradient); border: none; padding: 15px 30px; border-radius: 25px; color: white; font-weight: 600; width: 100%; font-size: 1.1rem; transition: all 0.3s ease; }
        .pay-btn:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(255, 107, 53, 0.3); color: white; }
        .pay-btn:disabled { opacity: 0.6; cursor: not-allowed; transform: none; }
        .reveal { opacity: 0; transform: translateY(30px); transition: all 0.6s ease; }
        .reveal.active { opacity: 1; transform: translateY(0); }
    </style>
}

<!-- Hero Section -->
<section class="hero-section">
    <div class="container">
        <div class="row align-items-center">
            <div class="col-lg-8">
                <h1 class="hero-title reveal">Thanh Toán</h1>
                <p class="hero-subtitle reveal">Hoàn tất đặt vé của bạn</p>
            </div>
            <div class="col-lg-4">
                <div class="text-center">
                    <i class="fas fa-credit-card fa-6x text-primary"></i>
                </div>
            </div>
        </div>
    </div>
</section>

<!-- Payment Section -->
<section class="section">
    <div class="container">
        <div class="row">
            <!-- Movie Info -->
            <div class="col-lg-4">
                <div class="movie-info-card reveal">
                    <img src="@(!string.IsNullOrEmpty(Model?.MoviePoster) ? Url.Content("~/" + Model.MoviePoster) : "https://placehold.co/400x250/ff6b35/ffffff?text=Movie")" alt="@(Model?.MovieTitle ?? "")" class="movie-poster" loading="lazy">
                    <div class="movie-details">
                        <h3 class="movie-title">@(Model?.MovieTitle ?? "")</h3>
                        <p class="movie-info">
                            <i class="fas fa-building me-2"></i>
                            @(Model?.TheaterName ?? "")
                        </p>
                        <p class="movie-info">
                            <i class="fas fa-calendar me-2"></i>
                            @(Model?.ShowDate.ToString("dd/MM/yyyy") ?? "")
                        </p>
                        <p class="movie-info">
                            <i class="fas fa-clock me-2"></i>
                            @(Model?.ShowTime.ToString(@"hh\:mm") ?? "")
                        </p>
                    </div>
                </div>
            </div>

            <!-- Payment Form -->
            <div class="col-lg-8">
                <div class="payment-container reveal">
                    <h3 class="mb-4">
                        <i class="fas fa-ticket-alt me-2"></i>
                        Thông Tin Đặt Vé
                    </h3>

                    <!-- Selected Seats -->
                    <div class="selected-seats">
                        <h5 class="mb-3">Ghế đã chọn:</h5>
                        @if (Model?.SelectedSeats != null)
                        {
                            @foreach (var seat in Model.SelectedSeats)
                            {
                                <div class="seat-item">
                                    <span class="seat-code">@seat.SeatCode (@(seat.SeatType == "VIP" ? "VIP" : "Thường"))</span>
                                    <span class="seat-price">@seat.Price.ToString("N0") VNĐ</span>
                                </div>
                            }
                        }
                    </div>

                    <!-- Discount Section -->
                    <div class="discount-section">
                        <h5 class="mb-3">Mã Giảm Giá</h5>
                        <div class="discount-input-group">
                            <input type="text" class="form-control discount-input" id="discountCode" placeholder="Nhập mã giảm giá">
                            <button type="button" class="apply-discount-btn" onclick="applyDiscount()">
                                <i class="fas fa-tag me-2"></i>Áp Dụng
                            </button>
                        </div>
                        <div id="discountMessage" class="mt-2"></div>
                    </div>

                    <!-- Payment Methods -->
                    <div class="payment-methods">
                        <h5 class="mb-3">Phương Thức Thanh Toán</h5>
                        <div class="payment-method" onclick="selectPaymentMethod('momo')">
                            <input type="radio" name="paymentMethod" value="momo" id="momo">
                            <label for="momo" class="mb-0">
                                <i class="fas fa-mobile-alt me-2 text-danger"></i>
                                Ví MoMo
                            </label>
                        </div>
                        <div class="payment-method" onclick="selectPaymentMethod('zalopay')">
                            <input type="radio" name="paymentMethod" value="zalopay" id="zalopay">
                            <label for="zalopay" class="mb-0">
                                <i class="fas fa-wallet me-2 text-blue"></i>
                                ZaloPay
                            </label>
                        </div>
                        <div class="payment-method" onclick="selectPaymentMethod('banking')">
                            <input type="radio" name="paymentMethod" value="banking" id="banking">
                            <label for="banking" class="mb-0">
                                <i class="fas fa-university me-2 text-success"></i>
                                Chuyển Khoản Ngân Hàng
                            </label>
                        </div>
                        <div class="payment-method" onclick="selectPaymentMethod('cash')">
                            <input type="radio" name="paymentMethod" value="cash" id="cash">
                            <label for="cash" class="mb-0">
                                <i class="fas fa-money-bill-wave me-2 text-warning"></i>
                                Tiền Mặt
                            </label>
                        </div>
                    </div>

                    <!-- Payment Summary -->
                    <div class="payment-summary">
                        <h5 class="mb-3">Tóm Tắt Thanh Toán</h5>
                        <div class="summary-item">
                            <span class="summary-label">Tổng tiền vé:</span>
                            <span class="summary-value" id="subtotal">@(Model?.SubTotal.ToString("N0") ?? "0") VNĐ</span>
                        </div>
                        <div class="summary-item" id="discountRow" style="display: none;">
                            <span class="summary-label">Giảm giá:</span>
                            <span class="summary-value text-success" id="discountAmount">-0 VNĐ</span>
                        </div>
                        <div class="summary-item total-amount">
                            <span class="summary-label">Tổng cộng:</span>
                            <span class="summary-value" id="totalAmount">@(Model?.TotalAmount.ToString("N0") ?? "0") VNĐ</span>
                        </div>
                    </div>

                    <!-- Pay Button -->
                    <button class="pay-btn" id="payBtn" onclick="processPayment()" disabled>
                        <i class="fas fa-credit-card me-2"></i>
                        Thanh Toán @(Model?.TotalAmount.ToString("N0") ?? "0") VNĐ
                    </button>
                </div>
            </div>
        </div>
    </div>
</section>

@section Scripts {
    <script>
        // theme toggle with persistence
        (function(){
            const body = document.body; const icon = document.getElementById('theme-icon'); const btn = document.getElementById('themeToggleBtn');
            const saved = localStorage.getItem('theme');
            if(saved === 'dark'){ body.setAttribute('data-theme','dark'); if(icon) icon.className='fas fa-sun'; }
            else if(saved === 'light'){ body.removeAttribute('data-theme'); if(icon) icon.className='fas fa-moon'; }
            if(btn){ btn.addEventListener('click', function(){ const dark = body.getAttribute('data-theme') === 'dark'; if(dark){ body.removeAttribute('data-theme'); localStorage.setItem('theme','light'); if(icon) icon.className='fas fa-moon'; } else { body.setAttribute('data-theme','dark'); localStorage.setItem('theme','dark'); if(icon) icon.className='fas fa-sun'; } }); }
        })();

        let currentDiscount = 0;
        let selectedPaymentMethod = '';

        // Select payment method
        function selectPaymentMethod(method) {
            selectedPaymentMethod = method;
            
            // Update UI
            document.querySelectorAll('.payment-method').forEach(el => {
                el.classList.remove('selected');
            });
            event.currentTarget.classList.add('selected');
            
            // Enable pay button
            document.getElementById('payBtn').disabled = false;
        }

        // Apply discount
        async function applyDiscount() {
            const discountCode = document.getElementById('discountCode').value.trim();
            const messageDiv = document.getElementById('discountMessage');
            
            if (!discountCode) {
                messageDiv.innerHTML = '<span class="text-warning">Vui lòng nhập mã giảm giá</span>';
                return;
            }

            try {
                const response = await fetch('@Url.Action("ApplyDiscount", "Booking")', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        discountCode: discountCode,
                        subTotal: @(Model?.SubTotal.ToString("F2", System.Globalization.CultureInfo.InvariantCulture) ?? "0")
                    })
                });

                const result = await response.json();

                if (result.success) {
                    currentDiscount = result.discountAmount;
                    updatePaymentSummary();
                    messageDiv.innerHTML = `<span class="text-success">Áp dụng mã giảm giá thành công! Giảm ${result.discountAmount.toLocaleString()} VNĐ</span>`;
                } else {
                    messageDiv.innerHTML = `<span class="text-danger">${result.message}</span>`;
                }
            } catch (error) {
                messageDiv.innerHTML = '<span class="text-danger">Có lỗi xảy ra khi áp dụng mã giảm giá</span>';
            }
        }

        // Update payment summary
        function updatePaymentSummary() {
            const subtotal = @(Model?.SubTotal.ToString("F2", System.Globalization.CultureInfo.InvariantCulture) ?? "0");
            const total = subtotal - currentDiscount;
            
            document.getElementById('discountRow').style.display = currentDiscount > 0 ? 'flex' : 'none';
            document.getElementById('discountAmount').textContent = `-${currentDiscount.toLocaleString()} VNĐ`;
            document.getElementById('totalAmount').textContent = `${total.toLocaleString()} VNĐ`;
            
            // Update pay button
            const payBtn = document.getElementById('payBtn');
            payBtn.innerHTML = `<i class="fas fa-credit-card me-2"></i>Thanh Toán ${total.toLocaleString()} VNĐ`;
        }

        // Process payment
        async function processPayment() {
            if (!selectedPaymentMethod) {
                Swal.fire({
                    icon: 'warning',
                    title: 'Chưa chọn phương thức thanh toán',
                    text: 'Vui lòng chọn phương thức thanh toán để tiếp tục',
                    confirmButtonText: 'Đóng',
                    confirmButtonColor: '#ffc107'
                });
                return;
            }

            const payBtn = document.getElementById('payBtn');
            const originalText = payBtn.innerHTML;
            payBtn.innerHTML = '<span class="loading"></span> Đang xử lý...';
            payBtn.disabled = true;

            try {
                const response = await fetch('@Url.Action("ProcessPayment", "Booking")', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        showtimeId: @(Model?.ShowtimeId ?? 0),
                        seatIds: [@(Model?.SelectedSeats != null ? string.Join(",", Model.SelectedSeats.Select(s => s.SeatId)) : "")],
                        totalAmount: @(Model?.SubTotal.ToString("F2", System.Globalization.CultureInfo.InvariantCulture) ?? "0") - currentDiscount,
                        paymentMethod: selectedPaymentMethod,
                        discountCode: document.getElementById('discountCode').value.trim() || null
                    })
                });

                const result = await response.json();

                if (result.success) {
                    Swal.fire({
                        html: `
                            <div class="mt-3">
                                <lord-icon src="https://cdn.lordicon.com/lupuorrc.json" trigger="loop" colors="primary:#0ab39c,secondary:#405189" style="width:120px;height:120px">
                                </lord-icon>
                                <div class="mt-4 pt-2 fs-15">
                                    <h4>${result.message}</h4>
                                    <p class="text-muted mx-4 mb-0">Mã đặt vé: ${result.bookingCode}</p>
                                </div>
                            </div>
                        `,
                        showConfirmButton: true,
                        confirmButtonText: 'Xem Chi Tiết',
                        confirmButtonColor: '#0ab39c',
                        allowOutsideClick: false,
                        allowEscapeKey: false,
                        customClass: {
                            popup: 'swal2-custom-popup',
                            confirmButton: 'btn btn-primary w-xs mb-1'
                        }
                    }).then(() => {
                        // Redirect to confirmation page
                        window.location.href = `@Url.Action("Confirmation", "Booking")?ticketId=${result.ticketIds[0]}`;
                    });
                } else {
                    Swal.fire({
                        icon: 'error',
                        title: 'Lỗi!',
                        text: result.message,
                        confirmButtonText: 'Đóng',
                        confirmButtonColor: '#dc3545'
                    });
                }
            } catch (error) {
                Swal.fire({
                    icon: 'error',
                    title: 'Lỗi!',
                    text: 'Có lỗi xảy ra khi xử lý thanh toán',
                    confirmButtonText: 'Đóng',
                    confirmButtonColor: '#dc3545'
                });
            } finally {
                payBtn.innerHTML = originalText;
                payBtn.disabled = false;
            }
        }
        
        // reveal animation
        function revealOnScroll(){ const els=document.querySelectorAll('.reveal'); els.forEach(el=>{ const wh=window.innerHeight; const top=el.getBoundingClientRect().top; if(top<wh-150){ el.classList.add('active'); } }); }
        window.addEventListener('scroll', revealOnScroll); 
        window.addEventListener('load', function() {
            revealOnScroll();
        });
    </script>
} 